{% extends "admin/base.html" %}

{% block title %}User: {{ user.email }}{% endblock %}
{% block page_title %}User Details{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px;">
    <!-- User Profile Card -->
    <div class="admin-table">
        <div style="padding: 24px; text-align: center;">
            <img src="{{ user.get_avatar(100) }}"
                style="width: 100px; height: 100px; border-radius: 50%; margin-bottom: 16px;">
            <h2 style="font-size: 20px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">
                {{ user.first_name }} {{ user.last_name }}
            </h2>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">{{ user.email }}</p>

            <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 16px;">
                <span class="badge" style="background: var(--primary); color: white;">Level {{ user.level }}</span>
                <span class="badge" style="background: {{ user.rank_color }}; color: white;">{{ user.rank }}</span>
            </div>

            {% if user.is_banned %}
            <div
                style="padding: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 8px; margin-bottom: 16px;">
                <div style="color: #ef4444; font-weight: 600; margin-bottom: 4px;">â›” BANNED</div>
                <div style="font-size: 13px; color: var(--text-secondary);">{{ user.ban_reason }}</div>
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">{{ user.banned_at.strftime('%b
                    %d, %Y') }}</div>
            </div>
            <form method="POST" action="{{ url_for('admin.unban_user', user_id=user.id) }}">
                <button type="submit" class="admin-btn admin-btn-primary" style="width: 100%;">
                    <i class="fa-solid fa-unlock"></i> Unban User
                </button>
            </form>
            {% else %}
            <button onclick="document.getElementById('banModal').style.display='block'"
                class="admin-btn admin-btn-danger" style="width: 100%;">
                <i class="fa-solid fa-ban"></i> Ban User
            </button>
            {% endif %}
        </div>
    </div>

    <!-- User Stats & Actions -->
    <div>
        <!-- Statistics -->
        <div class="admin-stats" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 24px;">
            <div class="admin-stat-card">
                <div class="admin-stat-icon" style="background: rgba(74, 222, 128, 0.1); color: #4ade80;">
                    <i class="fa-solid fa-star"></i>
                </div>
                <div class="admin-stat-info">
                    <div class="admin-stat-value">{{ user.total_xp }}</div>
                    <div class="admin-stat-label">Total XP</div>
                </div>
            </div>

            <div class="admin-stat-card">
                <div class="admin-stat-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                    <i class="fa-solid fa-list-check"></i>
                </div>
                <div class="admin-stat-info">
                    <div class="admin-stat-value">{{ completed_tasks }}/{{ total_tasks }}</div>
                    <div class="admin-stat-label">Tasks</div>
                </div>
            </div>

            <div class="admin-stat-card">
                <div class="admin-stat-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                    <i class="fa-solid fa-file-pdf"></i>
                </div>
                <div class="admin-stat-info">
                    <div class="admin-stat-value">{{ total_pdfs }}</div>
                    <div class="admin-stat-label">PDFs</div>
                </div>
            </div>
        </div>

        <!-- XP Adjustment -->
        <div class="admin-table" style="margin-bottom: 24px;">
            <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary);">Adjust XP</h3>
            </div>
            <div style="padding: 20px;">
                <form method="POST" action="{{ url_for('admin.adjust_xp', user_id=user.id) }}"
                    style="display: flex; gap: 12px; align-items: end;">
                    <div style="flex: 1;">
                        <label
                            style="display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-secondary);">Amount
                            (+ or -)</label>
                        <input type="number" name="amount" required placeholder="e.g., +500 or -200"
                            style="width: 100%; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                    </div>
                    <div style="flex: 2;">
                        <label
                            style="display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-secondary);">Reason</label>
                        <input type="text" name="reason" required placeholder="Reason for adjustment"
                            style="width: 100%; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                    </div>
                    <button type="submit" class="admin-btn admin-btn-primary">
                        <i class="fa-solid fa-check"></i> Apply
                    </button>
                </form>
            </div>
        </div>

        <!-- Recent XP Activity -->
        <div class="admin-table">
            <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary);">Recent XP Activity</h3>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Amount</th>
                        <th>Source</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                    {% for xp in recent_xp %}
                    <tr>
                        <td>
                            <span class="badge"
                                style="background: {% if xp.amount > 0 %}#10b981{% else %}#ef4444{% endif %}; color: white;">
                                {{ xp.amount|abs }} XP
                            </span>
                        </td>
                        <td>{{ xp.source.replace('_', ' ').title() }}</td>
                        <td>{{ xp.timestamp.strftime('%b %d, %I:%M %p') }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 20px; color: var(--text-secondary);">No XP
                            activity yet</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Ban Modal -->
<div id="banModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--bg-card); border-radius: 12px; padding: 24px; max-width: 500px; width: 90%;">
        <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 16px; color: var(--text-primary);">Ban User</h3>
        <form method="POST" action="{{ url_for('admin.ban_user', user_id=user.id) }}">
            <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);">Reason for ban:</label>
            <textarea name="reason" required rows="4" placeholder="Enter reason..."
                style="width: 100%; padding: 12px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); resize: vertical;"></textarea>
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button type="button" onclick="document.getElementById('banModal').style.display='none'"
                    class="admin-btn admin-btn-secondary" style="flex: 1;">Cancel</button>
                <button type="submit" class="admin-btn admin-btn-danger" style="flex: 1;">Ban User</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Close modal when clicking outside
    document.getElementById('banModal').addEventListener('click', function (e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    });
</script>
{% endblock %}