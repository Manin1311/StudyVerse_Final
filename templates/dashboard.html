{% extends "layout.html" %}

{% block title %}Dashboard - StudyVerse{% endblock %}

{% block content %}
<!-- Pixel Banner -->
<!-- <div class="pixel-banner" style="background-image: url('{{ url_for('static', filename=current_user.cover_image) if current_user.cover_image else url_for('static', filename='img/bg.jpg') }}'); background-size: cover; background-position: center;"> -->
<div class="pixel-banner" style="overflow: hidden; position: relative;">
    <video autoplay loop muted playsinline
        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0;">
        <source src="{{ url_for('static', filename='img/bg3.mp4') }}" type="video/mp4">
    </video>
    <div class="banner-overlay" style="z-index: 1;">
        <!-- Optional Icon overlay -->
        <i class="fa-solid fa-graduation-cap" style="font-size: 2rem; color: #fbbf24; display: none;"></i>
    </div>
</div>

<div class="page-header">
    <h1 class="page-title">Ultimate Student Planner</h1>
    <p class="text-muted">Welcome back, {{ current_user.first_name or 'Student' }}</p>
</div>

<!-- Home Layout Grid -->
<div class="layout-home">

    <!-- Left Column: Clock & Battle Status -->
    <div style="display: flex; flex-direction: column; gap: 24px;">

        <!-- Daily Quests Widget -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Daily Quests</div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 16px;">
                {% if quests %}
                {% for quest in quests %}
                <div style="display: flex; gap: 12px; align-items: center;">
                    <div style="width: 40px; height: 40px; background: rgba(var(--accent-green-rgb), 0.1); 
                        color: var(--accent-green); border-radius: 12px; display: grid; place-items: center; font-size: 1.1rem;
                        {{ 'opacity: 0.5; filter: grayscale(1);' if quest.completed else '' }}">
                        <i class="fa-solid {{ quest.icon }}"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span
                                style="font-weight: 600; font-size: 0.9rem; {{ 'text-decoration: line-through; color: var(--text-secondary);' if quest.completed else '' }}">
                                {{ quest.description }}
                            </span>
                            <span style="font-size: 0.8rem; color: var(--accent-purple); font-weight: 700;">+{{
                                quest.xp_reward }} XP</span>
                        </div>

                        <!-- Progress Bar -->
                        <div
                            style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                            <div
                                style="height: 100%; width: {{ (quest.progress / quest.target * 100)|int }}%; 
                                background: {{ 'var(--accent-green)' if quest.completed else 'var(--accent-blue)' } transition: width 0.5s;">
                            </div>
                        </div>
                        <div
                            style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px; text-align: right;">
                            {{ quest.progress }} / {{ quest.target }}
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div style="color: var(--text-secondary); font-style: italic;">All quests completed! come back tomorrow.
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Clock Widget -->
        <div class="card clock-widget" style="height: 180px; flex-direction: column; gap: 4px;">
            <div style="display: flex; gap: 8px;">
                <div id="clock-hour">00</div>
                <span style="font-size: 2rem; align-self: flex-start;">:</span>
                <div id="clock-min">00</div>
            </div>
            <div style="font-size: 1rem; font-family: var(--font-body); opacity: 0.8; font-weight: 500;" id="clock-day">
                SUNDAY</div>
            <span id="clock-ampm"
                style="position: absolute; bottom: 10px; left: 10px; font-size: 0.8rem; opacity: 0.7;">AM</span>
        </div>

        <!-- Study Progress Chart Widget -->
        <div class="card"
            style="height: 300px; padding: 20px; background: var(--bg-card); border: 1px solid var(--border); display: flex; flex-direction: column; position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                <div>
                    <h3 class="card-title">
                        <i class="fa-solid fa-chart-pie" style="color: var(--accent-purple);"></i> Study Progress
                    </h3>
                    <p class="text-muted" style="font-size: 0.8rem;">Task completion overview</p>
                </div>
            </div>

            <div style="flex: 1; position: relative; width: 100%; min-height: 0;">
                <canvas id="studyProgressChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Middle Column: Stats & Current Focus -->
    <div style="display: flex; flex-direction: column; gap: 24px;">

        <!-- Streak Widget (New) -->
        <div class="card"
            style="background: linear-gradient(135deg, rgba(255, 157, 0, 0.1), rgba(0,0,0,0)); border: 1px solid rgba(255, 157, 0, 0.3); padding: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; flex-direction: column;">
                    <span
                        style="font-size: 0.8rem; color: #ff9d00; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700;">Daily
                        Streak</span>
                    <div class="streak-counter">
                        <i class="fa-solid fa-fire"></i> {{ current_user.current_streak }} Days
                    </div>
                </div>
                <div style="text-align: right;">
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">Longest: {{
                        current_user.longest_streak }} Days</span>
                </div>
            </div>
        </div>

        <!-- Current Focus Widget -->
        <div class="card"
            style="background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(0,0,0,0)); border: 1px solid var(--accent-green);">
            <div class="card-header">
                <div class="card-title" style="display: flex; align-items: center; gap: 10px;">
                    <i class="fa-solid fa-bolt" style="color: var(--accent-green);"></i> Current Focus
                </div>
                <span class="badge badge-progress">In Progress</span>
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div style="flex: 1;">
                    {% if recent_todos and recent_todos[0] %}
                    <h2 style="font-size: 1.5rem; margin-bottom: 8px;">{{ recent_todos[0].title }}</h2>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">{{ recent_todos[0].category or 'General
                        Task' }}</p>
                    {% else %}
                    <h2 style="font-size: 1.5rem; margin-bottom: 8px;">Ready to Start?</h2>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">Add a task to begin your session.</p>
                    {% endif %}
                </div>
                <div class="flex-center"
                    style="width: 60px; height: 60px; border-radius: 50%; border: 4px solid var(--accent-green); font-weight: 700; font-size: 1.2rem;">
                    GO
                </div>
            </div>
            <div style="margin-top: 16px; display: flex; gap: 10px;">
                <a href="/pomodoro" class="btn-primary"
                    style="flex: 1; text-align: center; text-decoration: none;">Continue Session</a>
                <button
                    style="background: rgba(255,255,255,0.1); border: 1px solid var(--border); color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer;">
                    <i class="fa-solid fa-pause"></i>
                </button>
            </div>
        </div>

        <!-- Weekly Schedule Grid (Stats) -->
        <div class="schedule-grid">
            <div class="schedule-day">
                <div class="day-header">
                    <i class="fa-solid fa-star"></i> Total XP
                </div>
                <ul class="task-list">
                    <li class="task-item">
                        <span style="font-size: 1.5rem; font-weight: 700; color: #fbbf24;">{{ current_user.total_xp
                            }}</span>
                    </li>
                </ul>
            </div>

            <div class="schedule-day">
                <div class="day-header">
                    <i class="fa-solid fa-clock"></i> Study Hours
                </div>
                <ul class="task-list">
                    <li class="task-item">
                        <span style="font-size: 1.5rem; font-weight: 700;">
                            {% if weekly_hours > 0 %}{{ weekly_hours }}h{% else %}<span style="font-size: 1.2rem">&lt;
                                1h</span>{% endif %}
                        </span>
                        <span class="text-muted" style="font-size: 0.8rem;">This Week</span>
                    </li>
                </ul>
            </div>

            <div class="schedule-day">
                <div class="day-header">
                    <i class="fa-solid fa-list-check"></i> Tasks Done
                </div>
                <ul class="task-list">
                    <li class="task-item">
                        <span style="font-size: 1.5rem; font-weight: 700;">{{ completed_todos or 0 }}</span>
                        <span class="text-muted" style="font-size: 0.8rem;">/ {{ total_todos or 0 }} Total</span>
                    </li>
                </ul>
            </div>

            <div class="schedule-day">
                <div class="day-header">
                    <i class="fa-solid fa-chart-line"></i> Proficiency
                </div>
                <ul class="task-list">
                    <li class="task-item">
                        <span style="font-size: 1.5rem; font-weight: 700; color: var(--accent-green);">{{
                            avg_proficiency or 0 }}%</span>
                        <span class="text-muted" style="font-size: 0.8rem;">Average</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Right Column: High Priority & To-Dos -->
    <div style="display: flex; flex-direction: column; gap: 24px;">

        <!-- High Priority -->
        <div class="card"
            style="border: 1px solid rgba(239, 68, 68, 0.3); background: linear-gradient(to bottom, rgba(239, 68, 68, 0.05), transparent);">
            <h3
                style="color: #ef4444; font-family: var(--font-heading); margin-bottom: 16px; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                <i class="fa-solid fa-bullhorn"></i> Important
            </h3>
            <div id="high-priority-list" style="display: flex; flex-direction: column; gap: 12px;">
                {% if upcoming_todos and upcoming_todos|length > 0 %}
                {% for t in upcoming_todos[:3] %}
                <div
                    style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; border-left: 3px solid #ef4444;">
                    <div style="font-weight: 500; font-size: 0.95rem; margin-bottom: 4px;">{{ t.title }}</div>
                    <div style="font-size: 0.8rem; color: #ef4444;">Due: {{ t.due_date }}</div>
                </div>
                {% endfor %}
                {% else %}
                <div style="text-align: center; color: var(--text-secondary); font-size: 0.9rem;">No urgent deadlines.
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Weekly To-Dos -->
        <div class="weekly-todo">
            <!-- Heading with AI Button -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: var(--accent-green); font-family: var(--font-heading); font-size: 1.5rem; margin: 0;">
                    Recent Tasks
                </h3>
                <button onclick="openAIPlanModal()" class="btn-secondary"
                    style="font-size: 0.85rem; padding: 6px 12px; display: flex; align-items: center; gap: 6px;">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> AI Plan
                </button>
            </div>

            <div id="weekly-todo-list" style="display: flex; flex-direction: column; gap: 12px;">
                <details open style="cursor: pointer;">
                    <summary
                        style="list-style: none; display: flex; align-items: center; gap: 8px; font-weight: 500; color: var(--text-primary);">
                        <i class="fa-solid fa-caret-right" style="color: var(--text-secondary);"></i> Active Tasks
                    </summary>
                    <div style="padding-left: 20px; margin-top: 8px; color: var(--text-secondary); font-size: 0.9rem;">
                        {% if recent_todos %}
                        {% for t in recent_todos[:5] %}
                        <form action="{{ url_for('todos_toggle', todo_id=t.id) }}" method="POST" style="margin:0;">
                            <input type="hidden" name="next" value="{{ url_for('dashboard') }}">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px; cursor: pointer;"
                                onclick="this.parentNode.submit()">
                                <div class="task-checkbox {% if t.completed %}checked{% endif %}"></div>
                                <span
                                    style="{% if t.completed %}text-decoration: line-through; opacity: 0.6;{% endif %}">{{
                                    t.title }}</span>
                            </div>
                        </form>
                        {% endfor %}
                        {% else %}
                        <div>No recent tasks found.</div>
                        {% endif %}
                    </div>
                </details>
            </div>
        </div>

        <!-- Image Widget sidebar bottom -->
        <div style="border-radius: 12px; overflow: hidden; height: 150px; margin-top: auto;">
            <img src="{{ url_for('static', filename='img/bg.jpg') }}"
                style="width: 100%; height: 100%; object-fit: cover;" alt="Aesthetic">
        </div>

    </div>
</div>

<!-- AI Plan Modal -->
<div id="aiPlanModal" class="modal-overlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
    <div class="modal-content"
        style="background: var(--bg-card); padding: 30px; border-radius: 16px; width: 90%; max-width: 600px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="font-family: var(--font-heading); display: flex; align-items: center; gap: 10px;">
                <i class="fa-solid fa-robot" style="color: var(--accent-green);"></i> AI Focus Plan
            </h2>
            <button onclick="document.getElementById('aiPlanModal').style.display='none'"
                style="background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>

        <div id="aiPlanLoading" style="text-align: center; padding: 40px;">
            <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 2rem; color: var(--accent-green);"></i>
            <p style="margin-top: 16px; color: var(--text-secondary);">Generating your personalized plan...</p>
        </div>

        <div id="aiPlanContent"
            style="display: none; line-height: 1.6; color: var(--text-primary); max-height: 400px; overflow-y: auto;">
            <!-- Content goes here -->
        </div>

        <div style="margin-top: 24px; text-align: right;">
            <button onclick="document.getElementById('aiPlanModal').style.display='none'" class="btn-primary">Got
                it!</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function updateClock() {
        const now = new Date();
        const hours = now.getHours();
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const days = ['SUNDAY', 'MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'];

        const ampm = hours >= 12 ? 'PM' : 'AM';
        const hoursStr = String(hours).padStart(2, '0');

        document.getElementById('clock-hour').textContent = hoursStr;
        document.getElementById('clock-min').textContent = minutes;
        document.getElementById('clock-day').textContent = days[now.getDay()];
        const ampmElement = document.getElementById('clock-ampm');
        if (ampmElement) {
            ampmElement.textContent = ampm;
        }
    }
    setInterval(updateClock, 1000);
    updateClock();

    document.querySelector('[data-nav="dashboard"]').classList.add('active');

    // AI Plan Logic
    function openAIPlanModal() {
        const modal = document.getElementById('aiPlanModal');
        const loading = document.getElementById('aiPlanLoading');
        const content = document.getElementById('aiPlanContent');

        modal.style.display = 'flex';
        loading.style.display = 'block';
        content.style.display = 'none';

        fetch('/api/ai/plan')
            .then(r => r.json())
            .then(data => {
                loading.style.display = 'none';
                content.style.display = 'block';
                if (data.status === 'success') {
                    // Simple markdown check
                    content.innerHTML = marked.parse(data.plan);
                } else {
                    content.innerHTML = `<p style="color: #ef4444;">Error: ${data.message}</p>`;
                }
            })
            .catch(err => {
                loading.style.display = 'none';
                content.style.display = 'block';
                content.innerHTML = `<p style="color: #ef4444;">Failed to reach AI service.</p>`;
            });
    }
</script>
<!-- Markdown Parser for AI response -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const ctx = document.getElementById('studyProgressChart');
        if (ctx) {
            const completed = {{ completed_todos or 0 }};
        const total = {{ total_todos or 0 }};
    const pending = Math.max(0, total - completed);

    const isEmpty = total === 0;
    const dataValues = isEmpty ? [1] : [completed, pending];
    const bgColors = isEmpty ? ['rgba(255, 255, 255, 0.1)'] : ['#4ade80', '#3b82f6'];
    const labels = isEmpty ? ['No Tasks'] : ['Completed', 'Pending'];

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: dataValues,
                backgroundColor: bgColors,
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#a1a1aa',
                        font: {
                            family: "'Inter', sans-serif",
                            size: 11
                        },
                        usePointStyle: true,
                        boxWidth: 6
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(24, 24, 27, 0.9)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(255,255,255,0.1)',
                    borderWidth: 1,
                    callbacks: {
                        label: function (context) {
                            if (isEmpty) return ' Add tasks to track progress!';
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const percentage = Math.round((value / total) * 100);
                            return ` ${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '75%',
            animation: {
                animateScale: true,
                animateRotate: true
            }
        }
    });
        }
    });
</script>
{% endblock %}