{% extends "base.html" %}

{% block content %}
<!-- INJECT BOOTSTRAP 5 FOR ADMIN PANEL LAYOUT (Since base.html lacks it) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    /* RESET & OVERRIDES to fix conflicts between style.css and Bootstrap */
    .admin-wrapper {
        background-color: #0c0c0c;
        /* Match main bg */
        min-height: 100vh;
        color: #fff;
        font-family: 'Outfit', 'Inter', sans-serif;
        padding-bottom: 50px;
    }

    /* Bootstrap overrides for Dark Mode */
    .admin-wrapper .row {
        --bs-gutter-x: 1.5rem;
    }

    .glass-panel {
        background: rgba(24, 24, 27, 0.6);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border-radius: 16px;
    }

    .icon-box {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 48px;
        height: 48px;
        border-radius: 12px;
        font-size: 1.2rem;
    }

    /* Table Styles */
    .table-dark {
        --bs-table-bg: transparent;
        --bs-table-border-color: rgba(255, 255, 255, 0.05);
    }

    .table td,
    .table th {
        vertical-align: middle;
        padding: 1rem;
    }

    /* Buttons */
    .btn-outline-danger {
        border-color: rgba(239, 68, 68, 0.5);
        color: #f87171;
    }

    .btn-outline-danger:hover {
        background-color: rgba(239, 68, 68, 0.1);
        border-color: #f87171;
        color: #fff;
    }

    /* Scrollbar for container */
    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #0c0c0c;
    }

    ::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #444;
    }

    /* Ensure links don't have weird underlines */
    a {
        text-decoration: none;
    }
</style>

<div class="admin-wrapper">
    <div class="container-fluid px-4 py-4" style="max-width: 1600px;">

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-5 pt-3">
            <div>
                <h1
                    style="font-weight: 800; font-size: 2.5rem; letter-spacing: -1px; background: linear-gradient(135deg, #fff 0%, #4ade80 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0;">
                    <i class="fas fa-shield-alt me-3" style="color: #4ade80;"></i>Command Center
                </h1>
                <p class="text-secondary mb-0 mt-2" style="font-size: 1.1rem;">System Overview & Management Console</p>
            </div>
            <div class="d-flex gap-3">
                <button class="btn btn-outline-danger px-4 py-2"
                    onclick="window.location.href='{{ url_for('logout') }}'">
                    <i class="fas fa-sign-out-alt me-2"></i>Secure Logout
                </button>
            </div>
        </div>

        <!-- HUD Stats Cards -->
        <div class="row g-4 mb-5">
            <!-- Card 1 -->
            <div class="col-12 col-md-6 col-xl-3">
                <div class="glass-panel p-4 h-100"
                    style="background: linear-gradient(145deg, rgba(16, 185, 129, 0.05) 0%, rgba(0,0,0,0) 100%); border-color: rgba(16, 185, 129, 0.2);">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-secondary text-uppercase small mb-2"
                                style="letter-spacing: 1px; font-weight: 600;">Total Users</p>
                            <h2 class="mb-0 display-5" style="font-weight: 700; color: #4ade80;">{{ stats.users }}</h2>
                        </div>
                        <div class="icon-box" style="background: rgba(16, 185, 129, 0.1);">
                            <i class="fas fa-users text-success"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 2 -->
            <div class="col-12 col-md-6 col-xl-3">
                <div class="glass-panel p-4 h-100"
                    style="background: linear-gradient(145deg, rgba(59, 130, 246, 0.05) 0%, rgba(0,0,0,0) 100%); border-color: rgba(59, 130, 246, 0.2);">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-secondary text-uppercase small mb-2"
                                style="letter-spacing: 1px; font-weight: 600;">Study Groups</p>
                            <h2 class="mb-0 display-5" style="font-weight: 700; color: #60a5fa;">{{ stats.groups }}</h2>
                        </div>
                        <div class="icon-box" style="background: rgba(59, 130, 246, 0.1);">
                            <i class="fas fa-layer-group text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 3 -->
            <div class="col-12 col-md-6 col-xl-3">
                <div class="glass-panel p-4 h-100"
                    style="background: linear-gradient(145deg, rgba(245, 158, 11, 0.05) 0%, rgba(0,0,0,0) 100%); border-color: rgba(245, 158, 11, 0.2);">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-secondary text-uppercase small mb-2"
                                style="letter-spacing: 1px; font-weight: 600;">Syllabus Uploads</p>
                            <h2 class="mb-0 display-5" style="font-weight: 700; color: #fbbf24;">{{ stats.uploads }}
                            </h2>
                        </div>
                        <div class="icon-box" style="background: rgba(245, 158, 11, 0.1);">
                            <i class="fas fa-file-pdf text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 4 -->
            <div class="col-12 col-md-6 col-xl-3">
                <div class="glass-panel p-4 h-100"
                    style="background: linear-gradient(145deg, rgba(34, 197, 94, 0.05) 0%, rgba(0,0,0,0) 100%); border-color: rgba(34, 197, 94, 0.2);">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-secondary text-uppercase small mb-2"
                                style="letter-spacing: 1px; font-weight: 600;">System Status</p>
                            <h2 class="mb-0 display-6" style="font-weight: 700; color: #22c55e;">Online</h2>
                        </div>
                        <div class="icon-box" style="background: rgba(34, 197, 94, 0.1);">
                            <i class="fas fa-server text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Control Panel -->
        <div class="row g-4">
            <!-- User Management -->
            <div class="col-lg-8">
                <div class="glass-panel p-4 h-100">
                    <h4 class="mb-4"
                        style="font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;">
                        <i class="fas fa-users-cog me-2 text-primary"></i>User Integrity Management
                    </h4>

                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0">
                            <thead>
                                <tr>
                                    <th class="text-muted text-uppercase small" style="font-weight: 600;">ID</th>
                                    <th class="text-muted text-uppercase small" style="font-weight: 600;">User Identity
                                    </th>
                                    <th class="text-muted text-uppercase small" style="font-weight: 600;">Progression
                                    </th>
                                    <th class="text-muted text-uppercase small" style="font-weight: 600;">Joined</th>
                                    <th class="text-end text-muted text-uppercase small" style="font-weight: 600;">
                                        Controls</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td class="text-secondary">#{{ user.id }}</td>
                                    <td>
                                        <div class="d-flex align-items-center gap-3">
                                            <div class="avatar-sm"
                                                style="width: 40px; height: 40px; border-radius: 50%; background: #334155; overflow: hidden; flex-shrink: 0;">
                                                {% if user.profile_image %}
                                                <img src="{{ user.profile_image }}"
                                                    style="width: 100%; height: 100%; object-fit: cover;">
                                                {% else %}
                                                <div
                                                    class="w-100 h-100 d-flex align-items-center justify-content-center text-white font-weight-bold">
                                                    {{ user.first_name[0] if user.first_name else 'U' }}
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <div style="font-weight: 600; color: #f1f5f9;">{{ user.first_name }} {{
                                                    user.last_name }}</div>
                                                <div style="font-size: 0.85rem; color: #94a3b8;">{{ user.email }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column gap-1">
                                            <span class="badge bg-dark border border-secondary text-secondary"
                                                style="width: fit-content;">Level {{ user.level }}</span>
                                            <span class="badge bg-dark border border-success text-success"
                                                style="width: fit-content;">{{ user.total_xp }} XP</span>
                                        </div>
                                    </td>
                                    <td class="text-secondary">
                                        {{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}
                                    </td>
                                    <td class="text-end">
                                        {% if user.email != 'admin@studyverse.com' %}
                                        <form action="{{ url_for('admin_delete_user', user_id=user.id) }}" method="POST"
                                            class="d-inline"
                                            onsubmit="return confirm('CRITICAL WARNING: Are you sure you want to delete this user? This action cannot be undone.');">
                                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                                title="Delete User">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                        {% else %}
                                        <span
                                            class="badge bg-success bg-opacity-10 text-success border border-success px-3 py-2">Super
                                            Admin</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- System Logs / Quick Actions -->
            <div class="col-lg-4">
                <div class="glass-panel p-4 mb-4">
                    <h5 class="mb-4"
                        style="font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;">
                        <i class="fas fa-file-pdf me-2 text-warning"></i>Intercepted Uploads
                    </h5>
                    <div class="d-flex flex-column gap-3" style="max-height: 400px; overflow-y: auto;">
                        {% for doc in recent_uploads %}
                        <div class="p-3 d-flex align-items-center justify-content-between"
                            style="background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); transition: background 0.2s;">
                            <div class="d-flex align-items-center gap-3">
                                <div
                                    style="width: 32px; height: 32px; background: rgba(251, 191, 36, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-file-alt text-warning"></i>
                                </div>
                                <div style="overflow: hidden;">
                                    <div class="text-truncate text-white" style="max-width: 150px; font-weight: 500;">{{
                                        doc.filename }}</div>
                                    <div class="small text-secondary">by User #{{ doc.user_id }}</div>
                                </div>
                            </div>
                            <a href="{{ url_for('static', filename='uploads/' + doc.filename) }}" target="_blank"
                                class="btn btn-sm btn-dark border-secondary text-secondary hover-text-white">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        </div>
                        {% else %}
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-folder-open mb-3" style="font-size: 2rem; opacity: 0.5;"></i>
                            <p>No documents found in system.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="glass-panel p-4"
                    style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(6, 78, 59, 0.4) 100%); border: 1px solid rgba(16, 185, 129, 0.3);">
                    <h5 class="mb-3 text-success" style="font-weight: 700;"><i class="fas fa-terminal me-2"></i>System
                        Protocol</h5>
                    <p class="small text-light mb-0" style="opacity: 0.8; line-height: 1.6;">
                        <strong class="text-white">Notice:</strong> You are accessing the StudyVerse Root Command
                        Control. All administrative actions are logged.
                        User deletion is permanent and destructive (cascades to all associated data). Proceed with
                        caution.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}